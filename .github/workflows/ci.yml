# .github/workflows/ci.yml
# CI for yarnitt-wsl: runs lint, typecheck, tests and builds backend image.
# - "unit" job: fast checks (lint/typecheck/unit tests)
# - "integration" job: optional; uses service containers for Postgres/Redis/Mongo to run integration tests.
name: CI

on:
  push:
    branches: [ "main", "master", "chore/upgrade-eslint-ts" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  unit:
    name: Unit / Static checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install (root)
        run: npm ci

      - name: Backend: install deps
        working-directory: ./backend
        run: npm ci

      - name: Backend: lint
        working-directory: ./backend
        run: npm run lint

      - name: Backend: typecheck
        working-directory: ./backend
        run: npm run typecheck

      - name: Backend: unit tests
        working-directory: ./backend
        run: |
          if npm run | grep -q "test"; then
            npm test --if-present --silent
          else
            echo "No unit tests configured; consider adding jest/mocha tests"
          fi

      - name: Build backend Docker image (optional)
        if: env.BUILD_DOCKER != 'false'
        env:
          BUILD_DOCKER: true
        run: |
          # Build a local image to ensure Dockerfile builds (does not push)
          if [ -f ./backend/Dockerfile ]; then
            docker build -t yarnitt-backend:ci ./backend
          else
            echo "No backend/Dockerfile; skipping docker build"
          fi

  integration:
    name: Integration tests (Postgres/Redis/Mongo)
    runs-on: ubuntu-latest
    needs: unit
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: yarnitt_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d yarnitt_test"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
      mongo:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install backend deps
        working-directory: ./backend
        run: npm ci

      - name: Wait for services
        run: |
          # wait for postgres
          for i in $(seq 1 30); do
            pg_isready -h localhost -p 5432 -U postgres && break || sleep 1
          done
          # wait for redis
          for i in $(seq 1 30); do
            redis-cli -h localhost ping && break || sleep 1
          done
          # wait for mongo
          for i in $(seq 1 30); do
            mongosh --eval "db.adminCommand('ping')" && break || sleep 1
          done

      - name: Run integration tests
        working-directory: ./backend
        run: |
          if npm run | grep -q "test:integration"; then
            npm run test:integration
          else
            echo "No integration test script found (npm run test:integration)."
            echo "Add integration tests using a script like 'test:integration' which runs your test runner against the services"
          fi