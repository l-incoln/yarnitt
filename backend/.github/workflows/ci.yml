name: CI

on: push: branches: - main - 'fix/' - 'feature/' - 'hotfix/**' pull_request: branches: - main

jobs: build-and-test: runs-on: ubuntu-latest services: mongo: image: mongo:6.0 ports: - 27017:27017 options: >- --health-cmd="mongosh --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1 || exit 1" --health-interval=5s --health-timeout=5s --health-retries=10
env:
  MONGO_URI: mongodb://127.0.0.1:27017/yarnitt-test
  NODE_OPTIONS: --max-old-space-size=1024

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Use Node.js 20.x
    uses: actions/setup-node@v4
    with:
      node-version: "20"
      cache: "npm"

  - name: Install dependencies
    working-directory: ./backend
    run: |
      npm ci

  - name: Wait for Mongo to be ready
    run: |
      # Wait until mongosh can ping the server
      for i in {1..30}; do
        if npx --no-install mongosh --quiet --eval "db.adminCommand({ ping: 1 })" >/dev/null 2>&1; then
          echo "Mongo is ready"
          break
        fi
        echo "Waiting for Mongo... ($i)"
        sleep 1
      done

  - name: Run lint (if present)
    working-directory: ./backend
    run: |
      if [ -f package.json ] && jq -r '.scripts.lint // empty' package.json | grep -q .; then
        npm run lint || true
      else
        echo "No lint script detected, skipping"
      fi

  - name: Run tests
    working-directory: ./backend
    run: |
      npm test
    env:
      MONGO_URI: ${{ env.MONGO_URI }}

  - name: Upload coverage (if coverage dir exists)
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: backend-coverage
      path: backend/coverage || backend/coverage/** || ''

  - name: Archive test reports (if any)
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: backend-test-reports
      path: backend/test-results || ''
