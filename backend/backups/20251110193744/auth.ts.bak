import express from 'express';
import bcrypt from 'bcryptjs';
import User from '../models/User';
import SellerProfile from '../models/SellerProfile';
import { signTokens } from '../utils/jwt';

const router = express.Router();

// Register buyer
router.post('/register', async (req, res) => {
  const { email, password, name, phone } = req.body;
  if (!email || !password) return res.status(400).json({ error: 'Email and password required' });
  const existing = await User.findOne({ email });
  if (existing) return res.status(400).json({ error: 'Email already registered' });

  const hash = await bcrypt.hash(password, 10);
  const user = await User.create({ email, passwordHash: hash, name, phone, role: 'BUYER' });
  const tokens = signTokens({ id: user._id.toString(), role: user.role });
  res.json({ user: { id: user._id, email: user.email, name: user.name }, tokens });
});

// Register seller (creates user + seller profile pending approval)
router.post('/register-seller', async (req, res) => {
  const { email, password, name, phone, shopName, bio, kraPin } = req.body;
  if (!email || !password || !shopName) return res.status(400).json({ error: 'email, password and shopName required' });
  const existing = await User.findOne({ email });
  if (existing) return res.status(400).json({ error: 'Email already registered' });

  const hash = await bcrypt.hash(password, 10);
  const user = await User.create({ email, passwordHash: hash, name, phone, role: 'SELLER' });
  const seller = await SellerProfile.create({ user: user._id, shopName, bio, kraPin, approved: false });
  const tokens = signTokens({ id: user._id.toString(), role: user.role });
  res.json({ user: { id: user._id, email: user.email, role: user.role }, sellerId: seller._id, tokens });
});

// Login
router.post('/login', async (req, res) => {
  const { email, password } = req.body;
  if (!email || !password) return res.status(400).json({ error: 'Email and password required' });

  const user = await User.findOne({ email });
  if (!user) return res.status(401).json({ error: 'Invalid credentials' });

  const match = await bcrypt.compare(password, user.passwordHash);
  if (!match) return res.status(401).json({ error: 'Invalid credentials' });

  const tokens = signTokens({ id: user._id.toString(), role: user.role });
  res.json({ user: { id: user._id, email: user.email, role: user.role }, tokens });
});

export default router;
